<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- User Groups -->
        <record id="group_git_repository_admin" model="res.groups">
            <field name="name">Git Repository Administrator</field>
            <field name="category_id" ref="base.module_category_project"/>
            <field name="comment">Full access to Git repository management, configuration, and all mapping operations</field>
        </record>

        <record id="group_git_timesheet_user" model="res.groups">
            <field name="name">Git Timesheet Mapping User</field>
            <field name="category_id" ref="base.module_category_project"/>
            <field name="comment">Can view repositories, map commits to timesheets, and perform bulk operations</field>
        </record>

        <!-- Inherit from existing project groups -->
        <record id="group_git_repository_admin" model="res.groups">
            <field name="implied_ids" eval="[(4, ref('project.group_project_manager'))]"/>
        </record>

        <record id="group_git_timesheet_user" model="res.groups">
            <field name="implied_ids" eval="[(4, ref('hr_timesheet.group_hr_timesheet_user'))]"/>
        </record>

        <!-- Record Rules -->
        
        <!-- Git Repository access rules -->
        <record id="git_repository_rule_admin" model="ir.rule">
            <field name="name">Git Repository: Admin Access</field>
            <field name="model_id" ref="model_git_repository"/>
            <field name="groups" eval="[(4, ref('group_git_repository_admin'))]"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="True"/>
        </record>

        <record id="git_repository_rule_user" model="ir.rule">
            <field name="name">Git Repository: User Company Access</field>
            <field name="model_id" ref="model_git_repository"/>
            <field name="groups" eval="[(4, ref('group_git_timesheet_user'))]"/>
            <field name="domain_force">[('company_id', 'in', company_ids)]</field>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <!-- Git Commit access rules -->
        <record id="git_commit_rule_admin" model="ir.rule">
            <field name="name">Git Commit: Admin Access</field>
            <field name="model_id" ref="model_git_commit"/>
            <field name="groups" eval="[(4, ref('group_git_repository_admin'))]"/>
            <field name="domain_force">[(1, '=', 1)]</field>
        </record>

        <record id="git_commit_rule_user" model="ir.rule">
            <field name="name">Git Commit: User Company Access</field>
            <field name="model_id" ref="model_git_commit"/>
            <field name="groups" eval="[(4, ref('group_git_timesheet_user'))]"/>
            <field name="domain_force">[('company_id', 'in', company_ids)]</field>
        </record>

        <!-- Timesheet Commit Mapping access rules -->
        <record id="timesheet_mapping_rule_admin" model="ir.rule">
            <field name="name">Timesheet Mapping: Admin Access</field>
            <field name="model_id" ref="model_timesheet_commit_mapping"/>
            <field name="groups" eval="[(4, ref('group_git_repository_admin'))]"/>
            <field name="domain_force">[(1, '=', 1)]</field>
        </record>

        <record id="timesheet_mapping_rule_user" model="ir.rule">
            <field name="name">Timesheet Mapping: User Company Access</field>
            <field name="model_id" ref="model_timesheet_commit_mapping"/>
            <field name="groups" eval="[(4, ref('group_git_timesheet_user'))]"/>
            <field name="domain_force">[('company_id', 'in', company_ids)]</field>
        </record>

        <record id="timesheet_mapping_rule_own_only" model="ir.rule">
            <field name="name">Timesheet Mapping: Own Mappings Only</field>
            <field name="model_id" ref="model_timesheet_commit_mapping"/>
            <field name="groups" eval="[(4, ref('group_git_timesheet_user'))]"/>
            <field name="domain_force">['|', ('mapped_by', '=', user.id), ('timesheet_line_id.user_id', '=', user.id)]</field>
            <field name="perm_unlink" eval="False"/>
        </record>

        <!-- Menu Access Rights -->
        <record id="menu_git_timesheet_main" model="ir.ui.menu">
            <field name="name">Git Integration</field>
            <field name="parent_id" ref="project.menu_main_pm"/>
            <field name="sequence" eval="50"/>
            <field name="groups_id" eval="[(4, ref('group_git_timesheet_user'))]"/>
        </record>

        <record id="menu_git_repositories" model="ir.ui.menu">
            <field name="name">Repositories</field>
            <field name="parent_id" ref="menu_git_timesheet_main"/>
            <field name="action" ref="action_git_repository"/>
            <field name="sequence" eval="10"/>
            <field name="groups_id" eval="[(4, ref('group_git_timesheet_user'))]"/>
        </record>

        <record id="menu_git_commits" model="ir.ui.menu">
            <field name="name">Commits</field>
            <field name="parent_id" ref="menu_git_timesheet_main"/>
            <field name="action" ref="action_git_commit"/>
            <field name="sequence" eval="20"/>
            <field name="groups_id" eval="[(4, ref('group_git_timesheet_user'))]"/>
        </record>

        <record id="menu_timesheet_mappings" model="ir.ui.menu">
            <field name="name">Timesheet Mappings</field>
            <field name="parent_id" ref="menu_git_timesheet_main"/>
            <field name="action" ref="action_timesheet_commit_mapping"/>
            <field name="sequence" eval="30"/>
            <field name="groups_id" eval="[(4, ref('group_git_timesheet_user'))]"/>
        </record>

        <record id="menu_git_configuration" model="ir.ui.menu">
            <field name="name">Configuration</field>
            <field name="parent_id" ref="menu_git_timesheet_main"/>
            <field name="sequence" eval="90"/>
            <field name="groups_id" eval="[(4, ref('group_git_repository_admin'))]"/>
        </record>

        <!-- Server Actions Security -->
        <record id="server_action_sync_repositories" model="ir.actions.server">
            <field name="name">Sync All Repositories</field>
            <field name="model_id" ref="model_git_repository"/>
            <field name="state">code</field>
            <field name="code">records.action_sync_commits()</field>
            <field name="groups_id" eval="[(4, ref('group_git_repository_admin'))]"/>
        </record>

        <!-- Scheduled Actions Security -->
        <record id="ir_cron_sync_git_repositories" model="ir.cron">
            <field name="name">Sync Git Repositories</field>
            <field name="model_id" ref="model_git_repository"/>
            <field name="state">code</field>
            <field name="code">model.cron_sync_all_repositories()</field>
            <field name="interval_number">1</field>
            <field name="interval_type">days</field>
            <field name="numbercall">-1</field>
            <field name="active" eval="True"/>
            <field name="doall" eval="False"/>
        </record>

    </data>
</odoo>
